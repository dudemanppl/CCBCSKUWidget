const queryString=window.location.search;const urlParams=new URLSearchParams(queryString);const onBCActivityPage=!!urlParams.getAll("activity")[0];const onCompetitiveCyclist=window.location.host==="www.competitivecyclist.com";const siteString=onCompetitiveCyclist?"cc":"bc";const onPLP=document.getElementsByClassName("search-results").length;const onPDP=document.getElementsByClassName("js-kraken-pdp-body").length;chrome.runtime.sendMessage({onCompetitiveCyclist:onCompetitiveCyclist});const HTMLElem=(tagName,classList,id,textContent)=>{const newHTMLElem=document.createElement(tagName);if(classList){if(Array.isArray(classList)){newHTMLElem.classList.add(...classList)}else{throw new TypeError("Expected an array")}}if(id){newHTMLElem.id=id}if(textContent){newHTMLElem.textContent=textContent}return newHTMLElem};const WMSLink=productID=>{const newWMSLink=HTMLElem("a",classnamesForElem("WMSLink"),null,"Go to WMS");newWMSLink.setAttribute("type","button");newWMSLink.href=`https://manager.backcountry.com/manager/admin/item_inventory.html?item_id=${productID}`;return newWMSLink};const classnamesForElem=elem=>{const classnames=[siteString];const add=(...classes)=>{classnames.push(...classes)};if(elem==="WMSLink"||elem==="CopySKUButton"){add("btn","btn-reset");if(onPDP){add("pdp");if(onCompetitiveCyclist){add("btn--secondary")}else{add("product-buybox__btn")}}else{add("plp")}}if(elem==="WMSLink"){add("link-to-wms")}if(elem==="PLPPrice"){add("ui-pl-pricing__high-price","ui-pl-pricing--price-retail","js-item-price-high","qa-item-price-high")}return classnames};const copySKUButtonOnClick=({currentTarget:copySKUButton})=>{const SKU=document.getElementsByClassName("js-selected-product-variant")[0].value;if(SKU){navigator.clipboard.writeText(SKU);copySKUButton.textContent="Copied!";copySKUButton.classList.add("flash");setTimeout((()=>{copySKUButton.classList.remove("flash")}),100)}else{copySKUButton.textContent="Choose Item";copySKUButton.classList.add("no-variant-selected")}};const copySKUButtonOnMouseLeave=({currentTarget:copySKUButton})=>{copySKUButton.textContent="Copy SKU";copySKUButton.classList.remove("no-variant-selected")};const addMethodsToCopySKUButton=copySKUButton=>{copySKUButton.onmouseleave=copySKUButtonOnMouseLeave;copySKUButton.onclick=copySKUButtonOnClick};const copySKUButton=()=>{const newCopySKUButton=HTMLElem("button",classnamesForElem("CopySKUButton"),"copy-sku-button","Copy SKU");newCopySKUButton.setAttribute("type","button");addMethodsToCopySKUButton(newCopySKUButton);return newCopySKUButton};const addOOSAlertToCCPDP=()=>{for(const dropdownOption of document.getElementsByClassName("js-unifiedropdown-option")){const SKU=dropdownOption.getAttribute("sku-value");if(SKU&&!BC.product.skusCollection[SKU].inventory){dropdownOption.classList.add("oos-alert")}}};const anonFuncToStr=func=>func.toString().slice(5,-1);const invokeFuncInWindow=func=>{const scriptElem=HTMLElem("script",null,null,anonFuncToStr(func));document.head.append(scriptElem);scriptElem.remove()};const PDPTargetLocation=()=>{const[targetLocation]=document.getElementsByClassName(onCompetitiveCyclist?"add-to-cart":"js-buybox-actions");return targetLocation};const PDPProductID=()=>{const{value:productID}=document.querySelector('[name ="/atg/commerce/order/purchase/CartModifierFormHandler.productId"]');return productID};if(onPDP){if(onCompetitiveCyclist)invokeFuncInWindow(addOOSAlertToCCPDP);PDPTargetLocation().append(WMSLink(PDPProductID()),copySKUButton())}const BCDropdownCaret=()=>{const newBCDropdownCaret=document.createElementNS("http://www.w3.org/2000/svg","svg");newBCDropdownCaret.classList.add("bc-dropdown-caret");newBCDropdownCaret.setAttribute("viewBox","0 0 256 256");const svgPath=document.createElementNS("http://www.w3.org/2000/svg","path");svgPath.setAttribute("d","M203.628 107.72c-5.613 5.9-64.759 63.566-64.759 63.566-3.007 3.149-6.939 4.714-10.87 4.714-3.945 0-7.876-1.567-10.87-4.714 0 0-59.145-57.665-64.773-63.565-5.613-5.9-6-16.501 0-22.812 6.014-6.296 14.386-6.79 21.738 0l53.905 52.908 53.891-52.894c7.365-6.79 15.752-6.296 21.738 0 6.014 6.296 5.641 16.912 0 22.797z");svgPath.classList.add("caret-path");newBCDropdownCaret.append(svgPath);return newBCDropdownCaret};const PLPDropdownOpened=({classList:[firstClass]})=>firstClass==="plp-dropdown-options";const openPLPDropdownOptions=async({currentTarget:currentTarget},productID,productListingElems,state)=>{const{firstChild:currSelectedVariant,lastChild:lastChild}=currentTarget;if(PLPDropdownOpened(lastChild)){lastChild.classList.toggle("hidden")}else{const placeholderDropdown=HTMLElem("UL",["plp-dropdown-options","hidden",siteString]);currentTarget.append(placeholderDropdown);placeholderDropdown.replaceWith(await PLPSelectorDropdown(productID,currSelectedVariant,productListingElems,state))}};const closePLPDropdownOptions=PLPDropdownOptions=>{PLPDropdownOptions.classList.add("hidden")};const productListingElems=productListing=>{const[productListingImg]=productListing.getElementsByTagName("img");const[productListingPrice]=productListing.getElementsByClassName("ui-pl-pricing");const productListingElems=[productListingImg,productListingPrice];return productListingElems};const dropdownContainerEventHandlers=(productID,productListing,PLPSelectorDropdownContainer,state)=>{const[productListingImg,productListingPrice]=productListingElems(productListing);PLPSelectorDropdownContainer.onclick=event=>openPLPDropdownOptions(event,productID,[productListingImg,productListingPrice],state);productListing.onmouseleave=()=>{if(state.variantImgSrc){productListingImg.src=state.variantImgSrc}const[PLPSelectorDropdownContainer]=productListing.getElementsByClassName("plp-dropdown-options");PLPSelectorDropdownContainer&&closePLPDropdownOptions(PLPSelectorDropdownContainer)}};const PLPDropdownCurrSelectedVariant=()=>HTMLElem("div",["plp-dropdown-curr-selected-variant",siteString],null,"Select option");const PLPSelectorDropdownContainer=(productID,productListing)=>{const newPLPSelectorDropdownContainer=HTMLElem("div",["plp-dropdown-container",siteString]);const state={variantSelected:false,currentlySelectedOptionIdx:-1,variantImgSrc:null};newPLPSelectorDropdownContainer.append(PLPDropdownCurrSelectedVariant());if(!onCompetitiveCyclist){newPLPSelectorDropdownContainer.append(BCDropdownCaret())}dropdownContainerEventHandlers(productID,productListing,newPLPSelectorDropdownContainer,state);return newPLPSelectorDropdownContainer};const fetchJson=async url=>{const response=await fetch(url);const json=response.json();return json};const getItemInfo=async productID=>{const url=`https://api.backcountry.com/v1/products/${productID}?fields=skus.availability.stockLevel,skus.title,skus.id,skus.salePrice,skus.image&site=${onCompetitiveCyclist?"competitivecyclist":"bcs"}`;const itemInfo=await fetchJson(url);return itemInfo};const getVariants=async productID=>{const itemInfo=await getItemInfo(productID);const{products:[{skus:variants}]}=itemInfo;return variants};const usdString=num=>{const usdString=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2}).format(num);return usdString};const formatVariant=({salePrice:salePrice,id:id,availability:{stockLevel:stockLevel},title:title,image:{url:url}})=>{const formattedVariant={price:usdString(salePrice),SKU:id,outOfStock:!stockLevel,variant:title,imageSrc:`https://content.${onCompetitiveCyclist?"competitivecyclist":"backcountry"}.com${url}`};return formattedVariant};const toggleCurrOptionClass=(PLPSelectorDropdown,state)=>{PLPSelectorDropdown.childNodes[state.currentlySelectedOptionIdx].classList.toggle("curr-selected-option")};const highlightCurrSelectedOption=(PLPSelectorDropdown,state,newlySelectectedIdx)=>{if(newlySelectectedIdx!==state.currentlySelectedOptionIdx){if(state.currentlySelectedOptionIdx>=0){toggleCurrOptionClass(PLPSelectorDropdown,state)}state.currentlySelectedOptionIdx=newlySelectectedIdx;toggleCurrOptionClass(PLPSelectorDropdown,state)}};const dropdownOptions=async(productID,currSelectedVariant,productListingElems,state,PLPSelectorDropdown)=>{const variants=await getVariants(productID);const newDropdownOptions=variants.map(((variant,index)=>PLPSelectorDropdownOption(formatVariant(variant),state,currSelectedVariant,productListingElems,(()=>highlightCurrSelectedOption(PLPSelectorDropdown,state,index)))));return newDropdownOptions};const PLPSelectorDropdown=async(...args)=>{const newPLPSelectorDropdown=HTMLElem("ul",["plp-dropdown-options",siteString]);const options=await dropdownOptions(...args,newPLPSelectorDropdown);newPLPSelectorDropdown.append(...options);return newPLPSelectorDropdown};const updatePricingPLP=(productListingPrice,props,price)=>{const{variantSelected:variantSelected}=props;if(productListingPrice.firstChild.textContent!==price&&variantSelected){productListingPrice.firstChild.textContent=price}else if(!variantSelected){while(productListingPrice.lastChild){productListingPrice.lastChild.remove()}productListingPrice.append(HTMLElem("span",classnamesForElem("PLPPrice"),null,price));props.variantSelected=true}};const copySKUPLP=(currentOption,variant,SKU)=>{navigator.clipboard.writeText(SKU);currentOption.classList.toggle("copy-notif");currentOption.textContent="SKU Copied!";setTimeout((()=>{currentOption.classList.toggle("copy-notif");currentOption.textContent=variant}),300)};const singleOptionEventHandlers=(PLPSelectorDropdownOption,{price:price,SKU:SKU,outOfStock:outOfStock,variant:variant,imageSrc:imageSrc},props,currentOption,[productListingImg,productListingPrice],highlightCurrSelectedOption)=>{if(outOfStock)PLPSelectorDropdownOption.classList.add("oos-alert");PLPSelectorDropdownOption.onmouseenter=()=>{if(productListingImg.src!==imageSrc){productListingImg.src=imageSrc}};PLPSelectorDropdownOption.onclick=()=>{highlightCurrSelectedOption();updatePricingPLP(productListingPrice,props,price);copySKUPLP(currentOption,variant,SKU);props.variantImgSrc=imageSrc}};const PLPSelectorDropdownOption=(product,...params)=>{const{variant:variant,price:price}=product;const newPLPSelectorDropdownOption=HTMLElem("li",["plp-dropdown-option-single"],null,`${variant} (${price})`);singleOptionEventHandlers(newPLPSelectorDropdownOption,product,...params);return newPLPSelectorDropdownOption};const runOnAllElemsOfClass=(elemClassName,func)=>{const elems=[...document.getElementsByClassName(elemClassName)];for(const elem of elems){func(elem)}};const deleteAllElemsOfClass=elemClassName=>{runOnAllElemsOfClass(elemClassName,(elem=>elem.remove()))};const fixBCStyling=()=>{deleteAllElemsOfClass("ui-pl-info");deleteAllElemsOfClass("js-pl-color-thumbs");deleteAllElemsOfClass("js-pl-sizes-wrap")};const PLPWidgetContainer=(productID,productListing)=>{const newPLPWidgetContainer=HTMLElem("div",["plp-widget-container",siteString]);newPLPWidgetContainer.append(PLPSelectorDropdownContainer(productID,productListing),WMSLink(productID));return newPLPWidgetContainer};const getProductIDBCActivityPage=productListing=>{const productID=[...productListing.classList].pop().slice(-7);return productID};const addPLPSingleWidget=productListing=>{const productID=onBCActivityPage?getProductIDBCActivityPage(productListing):productListing.getAttribute("data-product-id");const targetLocation=productListing.firstChild;targetLocation.append(PLPWidgetContainer(productID,targetLocation))};const addAllPLPWidgets=()=>{if(!onCompetitiveCyclist){fixBCStyling()}runOnAllElemsOfClass(onBCActivityPage?"ui-product-listing":"js-product-listing",addPLPSingleWidget)};const nodeToObservePLP=()=>{const[nodeToObserve]=document.getElementsByClassName(onCompetitiveCyclist?"js-inner-body":onBCActivityPage?"product-listing__wrapper":"inner-body");return nodeToObserve};if(onPLP||onBCActivityPage){addAllPLPWidgets();new MutationObserver((()=>addAllPLPWidgets())).observe(nodeToObservePLP(),{childList:true})}