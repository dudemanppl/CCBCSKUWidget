const onCompetitiveCyclist =
  window.location.host === 'www.competitivecyclist.com';
const siteString = onCompetitiveCyclist ? 'cc' : 'bc';
const onPLP = document.getElementById('pageType').content.slice(0, 3) === 'plp';
const onPDP = document.getElementById('pageType').content === 'pdp';
 /**
 * Returns new HTML element given a tagName. Options to add id or classes.
 *
 * @param {string} tagName HTML tag name
 * @param {?array|string} [classList] Desired classes to add.
 * @param {?string} [id] Id for HTML element
 * @param {?string} [textContent] Text content inside new element
 */

const HTMLElem = (tagName, classList, id, textContent) => {
  const newHTMLElem = document.createElement(tagName);

  if (classList) {
    if (Array.isArray(classList)) {
      newHTMLElem.classList.add(...classList);
    } else {
      throw new TypeError('Expected an array');
    }
  }

  if (id) {
    newHTMLElem.id = id;
  }

  if (textContent) {
    newHTMLElem.textContent = textContent;
  }

  return newHTMLElem;
};

/**
 * Creates a button that links to WMS inventory page of desired product ID
 *
 * @param {string} productID Parent SKU for item from CC/BC catalog
 */

const WMSLink = (productID) => {
  const newWMSLink = HTMLElem(
    'a',
    classnamesForElem('WMSLink'),
    null,
    'Go to WMS'
  );

  newWMSLink.setAttribute('type', 'button');
  newWMSLink.href = `https://manager.backcountry.com/manager/admin/item_inventory.html?item_id=${productID}`;

  return newWMSLink;
};

const classnamesForElem = (elem) => {
  const classnames = [siteString];

  const add = (...classes) => {
    classnames.push(...classes);
  };

  if (elem === 'WMSLink' || elem === 'CopySKUButton') {
    add('btn', 'btn-reset');
    if (onPDP) {
      add('pdp');
      if (onCompetitiveCyclist) {
        add('btn--secondary');
      } else {
        add('product-buybox__btn');
      }
    } else {
      add('plp');
    }
  }

  if (elem === 'WMSLink') {
    add('link-to-wms');
  }

  if (elem === 'PLPPrice') {
    add(
      'ui-pl-pricing__high-price',
      'ui-pl-pricing--price-retail',
      'js-item-price-high',
      'qa-item-price-high'
    );
  }

  return classnames;
};

 const copySKUButtonOnClick = ({ currentTarget: copySKUButton }) => {
  const SKU = document.getElementsByClassName('js-selected-product-variant')[0]
    .value;

  if (SKU) {
    navigator.clipboard.writeText(SKU);
    copySKUButton.textContent = 'Copied!';
    copySKUButton.classList.add('flash');

    setTimeout(() => {
      copySKUButton.classList.remove('flash');
    }, 100);
  } else {
    copySKUButton.textContent = 'Choose Item';
    copySKUButton.classList.add('no-variant-selected');
  }
};

const copySKUButtonOnMouseLeave = ({ currentTarget: copySKUButton }) => {
  copySKUButton.textContent = 'Copy SKU';
  copySKUButton.classList.remove('no-variant-selected');
};

const addMethodsToCopySKUButton = (copySKUButton) => {
  copySKUButton.onmouseleave = copySKUButtonOnMouseLeave;
  copySKUButton.onclick = copySKUButtonOnClick;
};

/**
 * Creates a button to copy the full SKU of the selected variant on the PDP
 *
 * @returns {Element}
 */

const copySKUButton = () => {
  const newCopySKUButton = HTMLElem(
    'button',
    classnamesForElem('CopySKUButton'),
    'copy-sku-button',
    'Copy SKU'
  );
  newCopySKUButton.setAttribute('type', 'button');

  addMethodsToCopySKUButton(newCopySKUButton);

  return newCopySKUButton;
};

 const WMSLinkPDP = (productID) => {
  const newWMSLinkButton = HTMLElem('button', [
    'chakra-button',
    siteString,
    'wms-button-pdp',
  ]);
  const newWMSLink = HTMLElem('a', ['wms-link-pdp'], null, 'Go to WMS');

  newWMSLinkButton.setAttribute('type', 'button');
  newWMSLink.href = `https://manager.backcountry.com/manager/admin/item_inventory.html?item_id=${productID}`;

  newWMSLinkButton.append(newWMSLink);

  return newWMSLinkButton;
};

if (onPDP) {
  const newCopySKUButton = HTMLElem(
    'button',
    ['chakra-button', siteString, 'copy-sku-button-pdp'],
    null,
    'Copy SKU'
  );

  newCopySKUButton.setAttribute('type', 'button');

  const copySKU = () => {
    navigator.clipboard.writeText(
      currentlySelectedVariantSKU || 'Error copying SKU'
    );
  };

  let currentlySelectedVariantSKU;

  const variantSelector = document.getElementById('buybox-variant-selector');

  const hasDropdown = variantSelector.children.length === 2;

  if (hasDropdown) {
    const variantDropdown = variantSelector.querySelector('ul');

    for (let i = 0; i < variantDropdown.children.length; i += 1) {
      const variant = variantDropdown.children[i];
      const fullSKU = variant.getAttribute('value');

      if (i === 0) {
        currentlySelectedVariantSKU = fullSKU;
      }

      variant.onclick = () => {
        currentlySelectedVariantSKU = fullSKU;
      };
    }

    newCopySKUButton.onclick = copySKU;
  } else {
    let currentlySelectedSize;

    const itemsOfferedElements = document.querySelectorAll(
      '[itemprop="itemOffered"]'
    );

    const items = {};

    for (const item of itemsOfferedElements) {
      const [{ content: variantAndSize }, { content: fullSKU }] = item.children;
      const [variant, size] = variantAndSize.split(`, `);

      items[variant] = { ...items[variant], [size]: fullSKU };
    }
    const sizeSelectorElem = variantSelector.lastChild.lastChild;

    for (const singleSizeSelectWrapper of sizeSelectorElem.children) {
      const { firstChild, lastChild } = singleSizeSelectWrapper;

      const actualSize = firstChild.getAttribute('value');

      const singleSizeSelectElem = lastChild;

      singleSizeSelectElem.onclick = () => {
        currentlySelectedSize = actualSize;
      };
    }

    newCopySKUButton.onclick = () => {
      const colorSelector = variantSelector.firstChild.lastChild;
      const currentlySelectedColor = colorSelector.textContent;

      const fullSKU = items[currentlySelectedColor][currentlySelectedSize];

      currentlySelectedVariantSKU = fullSKU;

      copySKU();
    };
  }

  const PDPTargetLocation = document.getElementById('buybox-variant-selector')
    .nextSibling.nextSibling;

  const parentSKU = document
    .querySelector('[data-id="productId"]')
    .innerText.slice(-7);

  PDPTargetLocation.append(WMSLinkPDP(parentSKU), newCopySKUButton);
}
 /**
 * Creates dropdown caret
 */

const dropdownCaret = () => {
  const newDropdownCaret = document.createElementNS(
    'http://www.w3.org/2000/svg',
    'svg'
  );

  newDropdownCaret.classList.add('dropdown-caret');

  if (onCompetitiveCyclist) {
    newDropdownCaret.classList.add('cc');
  }
  newDropdownCaret.setAttribute('viewBox', '0 0 256 256');

  const svgPath = document.createElementNS(
    'http://www.w3.org/2000/svg',
    'path'
  );

  svgPath.setAttribute(
    'd',
    'M203.628 107.72c-5.613 5.9-64.759 63.566-64.759 63.566-3.007 3.149-6.939 4.714-10.87 4.714-3.945 0-7.876-1.567-10.87-4.714 0 0-59.145-57.665-64.773-63.565-5.613-5.9-6-16.501 0-22.812 6.014-6.296 14.386-6.79 21.738 0l53.905 52.908 53.891-52.894c7.365-6.79 15.752-6.296 21.738 0 6.014 6.296 5.641 16.912 0 22.797z'
  );

  svgPath.classList.add('caret-path');

  newDropdownCaret.append(svgPath);

  return newDropdownCaret;
};

 /**
 * Returns boolean of whether or not the dropdown has been opened for a particular item
 *
 * @param {Element} target Location to check if the PLP dropdown has been previously opened
 * @return {boolean}
 */

const PLPDropdownOpened = ({ classList: [firstClass] }) => {
  return firstClass === 'plp-dropdown-options';
};

/**
 * @param {Event} event From event handler
 * @param {string} productID Parent SKU for item from CC/BC catalog
 * @param {Element[]} productListingElems Tuple of elements with price and image
 * @param {object} state Data about the component
 */

const openPLPDropdownOptions = async (
  { currentTarget },
  productID,
  productListingElems,
  state
) => {
  const { firstChild: currSelectedVariant, lastChild } = currentTarget;

  if (PLPDropdownOpened(lastChild)) {
    lastChild.classList.toggle('hidden');
  } else {
    /** Element won't be created until it is clicked */
    const placeholderDropdown = HTMLElem('UL', [
      'plp-dropdown-options',
      'hidden',
      siteString,
    ]);

    currentTarget.append(placeholderDropdown);

    placeholderDropdown.replaceWith(
      await PLPSelectorDropdown(
        productID,
        currSelectedVariant,
        productListingElems,
        state
      )
    );
  }
};

/**
 * @param {Element} PLPDropdownOptions
 */

const closePLPDropdownOptions = (PLPDropdownOptions) => {
  PLPDropdownOptions.classList.add('hidden');
};

/**
 * Returns tuple of elements with price and image to pass to event handlers
 *
 * @param {Element} productListing PLI product listing where widget was added
 * @return {array}
 */

const productListingElems = (productListing) => {
  const [productListingImg] = productListing.getElementsByTagName('img');
  const [productListingPrice] =
    productListing.getElementsByClassName('ui-pl-pricing');

  const productListingElems = [productListingImg, productListingPrice];

  return productListingElems;
};

/**
 * Opens and closes the dropdown options on PLP
 *
 * @param {string} productID Parent SKU for item from CC/BC catalog
 * @param {Element} productListing PLI product listing where widget was added
 * @param {Element} PLPSelectorDropdownContainer
 * @param {object} state Data about the component
 */

const dropdownContainerEventHandlers = (
  productID,
  productListing,
  PLPSelectorDropdownContainer,
  state
) => {
  const [productListingImg, productListingPrice] =
    productListingElems(productListing);

  PLPSelectorDropdownContainer.onclick = (event) =>
    openPLPDropdownOptions(
      event,
      productID,
      [productListingImg, productListingPrice],
      state
    );

  productListing.onmouseleave = () => {
    if (state.variantImgSrc) {
      productListingImg.src = state.variantImgSrc;
    }

    const [PLPSelectorDropdownContainer] =
      productListing.getElementsByClassName('plp-dropdown-options');

    PLPSelectorDropdownContainer &&
      closePLPDropdownOptions(PLPSelectorDropdownContainer);
  };
};

/**
 * Creates element that lists the currently selected variant
 * @return {Element}
 */

const PLPDropdownCurrSelectedVariant = () => {
  return HTMLElem(
    'div',
    ['plp-dropdown-curr-selected-variant', siteString],
    null,
    'Select option'
  );
};

/**
 * Creates container for PLP variant selector
 *
 * @param {string} productID Parent SKU for item from CC/BC catalog
 * @param {Element} productListing PLI product listing where widget was added
 * @return {Element}
 */

const PLPSelectorDropdownContainer = (productID, productListing) => {
  const newPLPSelectorDropdownContainer = HTMLElem('div', [
    'plp-dropdown-container',
    siteString,
  ]);

  const state = {
    variantSelected: false,
    currentlySelectedOptionIdx: -1,
    variantImgSrc: null,
  };

  newPLPSelectorDropdownContainer.append(
    PLPDropdownCurrSelectedVariant(),
    dropdownCaret()
  );

  dropdownContainerEventHandlers(
    productID,
    productListing,
    newPLPSelectorDropdownContainer,
    state
  );

  return newPLPSelectorDropdownContainer;
};

 /**
 * Returns JSON response of HTTP get request
 *
 * @param {string} url URL to send request to
 * @return {Object}
 */

const fetchJson = async (url) => {
  const response = await fetch(url);
  const json = response.json();

  return json;
};

/**
 * Returns item information for a product ID from CC/BC catalog
 *
 * @param {string} productID Parent SKU for item from CC/BC catalog
 * @return {Object}
 */

const getItemInfo = async (productID) => {
  const url = `https://api.backcountry.com/v1/products/${productID}?fields=skus.availability.stockLevel,skus.title,skus.id,skus.salePrice,skus.image&site=${
    onCompetitiveCyclist ? 'competitivecyclist' : 'bcs'
  }`;
  const itemInfo = await fetchJson(url);

  return itemInfo;
};

/**
 * Returns array of variants for a product id
 *
 * @param {string} productID Parent SKU for item from CC/BC catalog
 * @return {Object[]}
 */

const getVariants = async (productID) => {
  const itemInfo = await getItemInfo(productID);

  const {
    products: [{ skus: variants }],
  } = itemInfo;

  return variants;
};

/**
 * Formats number in to string in form of $xx.xx
 *
 * @param {number} num
 * @return {string} In form of $xx.xx
 */

const usdString = (num) => {
  const usdString = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2,
  }).format(num);

  return usdString;
};

/**
 * Formats a product to be more easily usable
 *
 * @param {Object} product Original product to take values from
 * @return {Object}
 */

const formatVariant = ({
  salePrice,
  id,
  availability: { stockLevel },
  title,
  image: { url },
}) => {
  const formattedVariant = {
    price: usdString(salePrice),
    SKU: id,
    outOfStock: !stockLevel,
    variant: title,
    imageSrc: `https://content.${
      onCompetitiveCyclist ? 'competitivecyclist' : 'backcountry'
    }.com${url}`,
  };

  return formattedVariant;
};

/**
 * Toggles classname of given element to highlight/unhighlight it
 *
 * @param {Element} PLPSelectorDropdown
 * @param {object} state Data about the component
 * @param {number} state.currentlySelectedOptionIdx Index of the currently selected option
 */

const toggleCurrOptionClass = (PLPSelectorDropdown, state) => {
  PLPSelectorDropdown.childNodes[
    state.currentlySelectedOptionIdx
  ].classList.toggle('curr-selected-option');
};

/**
 * Highlights the selected option on a PLP dropdown
 *
 * @param {number} newlySelectectedIdx Index of newly selected option
 */

/**
 * Highlights the selected option on a PLP dropdown
 *
 * @param {Element} PLPSelectorDropdown
 * @param {object} state Data about the component
 * @param {number} newlySelectectedIdx Index of newly selected option
 */

const highlightCurrSelectedOption = (
  PLPSelectorDropdown,
  state,
  newlySelectectedIdx
) => {
  if (newlySelectectedIdx !== state.currentlySelectedOptionIdx) {
    if (state.currentlySelectedOptionIdx >= 0) {
      toggleCurrOptionClass(PLPSelectorDropdown, state);
    }

    state.currentlySelectedOptionIdx = newlySelectectedIdx;
    toggleCurrOptionClass(PLPSelectorDropdown, state);
  }
};

/**
 *  Adds all options to the dropdown
 * @param {string} productID Parent SKU for item from CC/BC catalog
 * @param {Element} currSelectedVariant Element that shows the currently selected variant
 * @param {Element[]} productListingElems Tuple of elements with price and image
 * @param {object} state Data about the component
 * @param {Element} PLPSelectorDropdown
 */

/* istanbul ignore next */
const dropdownOptions = async (
  productID,
  currSelectedVariant,
  productListingElems,
  state,
  PLPSelectorDropdown
) => {
  const variants = await getVariants(productID);

  const newDropdownOptions = variants.map((variant, index) =>
    PLPSelectorDropdownOption(
      formatVariant(variant),
      state,
      currSelectedVariant,
      productListingElems,
      () => highlightCurrSelectedOption(PLPSelectorDropdown, state, index)
    )
  );

  return newDropdownOptions;
};

/**
 * Creates variant selector dropdown on PLP with price and stock information
 *
 * @return {Element}
 */

/* istanbul ignore next */
const PLPSelectorDropdown = async (...args) => {
  const newPLPSelectorDropdown = HTMLElem('ul', [
    'plp-dropdown-options',
    siteString,
  ]);

  const options = await dropdownOptions(...args, newPLPSelectorDropdown);

  newPLPSelectorDropdown.append(...options);

  return newPLPSelectorDropdown;
};

 /**
 * Updates pricing shown on PLP if variant pricing changes
 * @param {Element} productListingPrice Reference to the element with pricing information
 * @param {boolean} props.variantSelected Boolean of whether or not an variant has been selected from the current dropdown
 * @param {string} price Sale price of an item
 */

// const updatePricingPLP = (productListingPrice, props, price) => {
//   const { variantSelected } = props;

//   if (productListingPrice.firstChild.textContent !== price && variantSelected) {
//     productListingPrice.firstChild.textContent = price;
//   } else if (!variantSelected) {
//     /** Removes current elements related to price if variant has not been selected yet */
//     while (productListingPrice.lastChild) {
//       productListingPrice.lastChild.remove();
//     }

//     productListingPrice.append(
//       HTMLElem('span', classnamesForElem('PLPPrice'), null, price)
//     );

//     props.variantSelected = true;
//   }
// };

/**
 *
 * @param {Element} currentOption Reference to HTML elem with the current option chosen
 * @param {string} variant Name of the variant of the item
 * @param {string} SKU Child SKU of an item
 */

const copySKUPLP = (currentOption, variant, SKU) => {
  /** Copies SKU to clipboard */
  navigator.clipboard.writeText(SKU);
  /** Shows short notification of copy */
  currentOption.classList.toggle('copy-notif');
  currentOption.textContent = 'SKU Copied!';

  setTimeout(() => {
    currentOption.classList.toggle('copy-notif');
    currentOption.textContent = variant;
  }, 300);
};

/**
 * @param {Element} PLPSelectorDropdownOption Single PLP selector dropdown option
 * @param {object} product Object containing info about an item
 * @param {string} product.price Sale price of an item
 * @param {string} product.SKU Child SKU of an item
 * @param {boolean} product.outOfStock Whether the item is out of stock or not
 * @param {string} product.variant Name of the variant of the item
 * @param {string} product.imageSrc URL of the source of the image of the item
 * @param {object} props Props passed down from parent
 * @param {Element} currentOption Reference to HTML elem with the current option chosen
 * @param {Element} productListingImg Reference to image of current product listing
 * @param {Element} productListingPrice Reference to the element with pricing information
 * @param {function} highlightCurrSelectedOption Function to change the highlighting of the currently selected variant
 */

const singleOptionEventHandlers = (
  PLPSelectorDropdownOption,
  { price, SKU, outOfStock, variant, imageSrc },
  props,
  currentOption,
  [productListingImg, productListingPrice],
  highlightCurrSelectedOption
) => {
  /** Adds OOS alert as necessary */
  if (outOfStock) PLPSelectorDropdownOption.classList.add('oos-alert');

  PLPSelectorDropdownOption.onmouseenter = () => {
    /** Changes image source if variant image changes */
    if (productListingImg.src !== imageSrc) {
      productListingImg.src = imageSrc;
    }
  };

  /* istanbul ignore next */
  PLPSelectorDropdownOption.onclick = () => {
    highlightCurrSelectedOption();
    // updatePricingPLP(productListingPrice, props, price);
    copySKUPLP(currentOption, variant, SKU);
    props.variantImgSrc = imageSrc;
  };
};

/**
 * Creates single dropdown option
 *
 * @param {Object} product Object containing info about an item
 */

const PLPSelectorDropdownOption = (product, ...params) => {
  const { variant, price } = product;
  const newPLPSelectorDropdownOption = HTMLElem(
    'li',
    ['plp-dropdown-option-single'],
    null,
    `${variant} (${price})`
  );

  singleOptionEventHandlers(newPLPSelectorDropdownOption, product, ...params);

  return newPLPSelectorDropdownOption;
};

 /**
 * Creates main SKU Widget container for PLP
 *
 * @param {string} productID Parent SKU for item from CC/BC catalog
 * @param {Element} productListing PLP product listing where widget was added
 */

const PLPWidgetContainer = (productID, productListing) => {
  const newPLPWidgetContainer = HTMLElem('div', [
    'plp-widget-container',
    siteString,
  ]);

  newPLPWidgetContainer.append(
    PLPSelectorDropdownContainer(productID, productListing),
    WMSLink(productID)
  );

  return newPLPWidgetContainer;
};

/**
 * Adds single widget to the PLP
 *
 * @param {Element} productListing PLP product listing
 */

const addPLPSingleWidget = (productListing) => {
  const imgSrc = productListing.querySelector('img').src;
  const sliceStart = onCompetitiveCyclist ? 60 : 53;
  const sliceIndexs = [sliceStart, sliceStart + 7];

  const productID = imgSrc.slice(...sliceIndexs);

  const targetLocation = productListing.lastChild;

  targetLocation.append(PLPWidgetContainer(productID, targetLocation));
};

/**
 * Adds all widgets to DOM
 */

const addAllPLPWidgets = () => {
  const PLPItems = document.querySelectorAll('[data-id="productListingItems"]');

  for (const productListing of PLPItems) {
    addPLPSingleWidget(productListing);
  }
};

if (onPLP) {
  addAllPLPWidgets();

  const nodeToObservePLP = document.querySelector('[data-id="productsWrap"]');

  /** Watches for changes on SPA to rerender PLP widgets */
  new MutationObserver(() => addAllPLPWidgets()).observe(nodeToObservePLP, {
    childList: true,
  });
}
